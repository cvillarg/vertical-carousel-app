<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="carousel-item/carousel-item.html">

<!--
`<vertical-carousel>` description.

Example:

```html
<vertical-carousel></vertical-carousel>
```

## Styling

The following custom properties and mixins are available for styling:

| Custom property | Description     | Default        |
|:---------------:|:---------------:| :-------------:|
| --your-var      | var description | default value  |
| --vertical-carousel | empty mixin     | {}             |

@demo demo/index.html
-->
<dom-module id="vertical-carousel">
  <style>
  :host{
    display: block;
    height: 300px;
    overflow: auto;
  }
  </style>
  <template>
      <template is="dom-repeat" items=[[items]]>
        <carousel-item class$="[[item.color]]" title="[[item.title]]" subtitle="[[item.subtitle]]" content="[[item.content]]"></carousel-item>
      </template>
  </template>
  <script>
  (function(){
    /* I dont want these stuff inside Polymer */
    var onDebounce; //to avoid jitter (be called after it changes scroll)
    var midPoint;
    //var itemNodes;

    // Thanks Mr Penner - http://robertpenner.com/easing/
    function easeInOutQuad (t, b, c, d) {
      t /= d / 2;
      if ( t < 1 ) return c / 2 * t * t + b;
      t--;
      return -c / 2 * ( t * ( t -2 ) - 1 ) + b;
    }

    'use strict';
    Polymer({
      is: 'vertical-carousel',
      properties: {
        items: {
          type: Array,
          value: function() {
            return [];
          }
        },
        currentItem: {
          type: Number,
          value: 0
        }
      },

      listeners: {
        //'scroll': '_onScroll'
      },

      ready: function () {
        // var that = Array.prototype.slice.call(this.childNodes).filter(function(item) { //doesnt work
        //   console.log('item', item.localName);
        //   return item.localName === 'carousel-item';
        // });
        //this.itemNodes = this.querySelectorAll('carousel-item');
      },

      attached: function(){
        //console.log(this, this.querySelectorAll('carousel-item'), this.childNodes); //doesnt work
        var that = Array.prototype.slice.call(this.childNodes)//.filter(function(item) {
        //   console.log('item', item.localName);
        //   return item.localName === 'carousel-item';
        // });
        var top = this.getBoundingClientRect().top;
        var bottom = this.getBoundingClientRect().bottom;
        midPoint = ((bottom+top)/2>>0);
        this.listen(this, 'scroll', '_onScroll');
      },

      detached: function(){
        this.unlisten(this, 'scroll', '_onScroll');
      },

      _onDebounce: function() {
        var firstCall = false; //lexical retention to be called once every two times
        return function(i, itemNodes) {
          this.debounce('doSomething', function () {
            console.log('onDebounce');
            // if (firstCall){
            //   firstCall = false; //it's not firstCall hence reset counter
            // } else {
              firstCall = true;
              var sum = 0;
              for (var j = 0; j < i; j++) {
                sum += itemNodes[j].offsetHeight+17;
              }
              console.log('do debounce! from', this.scrollTop, 'to', sum);
              //this.scrollTop = sum;
              this.unlisten(this, 'scroll', '_onScroll');
              this._elevator(this.scrollTop, sum);
            //}
          }, 500);
        }.bind(this);
      },

      _onScroll : function (e) {
        var itemNodes = this.querySelectorAll('carousel-item');
        //var top = this.getBoundingClientRect().top;
        //var bottom = this.getBoundingClientRect().bottom;
        var i = 0;
        while(itemNodes[i].getBoundingClientRect().bottom < midPoint){
          i++;
        }
        if ( this.currentItem != i ) { //dirty checking
          this.currentItem = i;
          console.log('current item', i);
        }
        console.log('scroll', i);
        onDebounce = onDebounce || this._onDebounce();

        onDebounce(i, itemNodes);
      },

      _elevator: function(from, to){
        var duration = ( Math.abs(to - from) * 1.5);
        requestAnimationFrame( this._animateLoop(from, to, duration) );
      },

      _animateLoop: function (startPosition, endPosition, duration){
        var startTime;
        return function aux (time) {
          if ( !startTime ) {
            startTime = time;
          }

          var timeSoFar = time - startTime;
          var easedPosition = easeInOutQuad(timeSoFar, startPosition, endPosition - startPosition, duration);
          console.log('scrolling from', startPosition, 'to', easedPosition, 'finish', endPosition);
          this.scrollTop = easedPosition;

          if( timeSoFar < duration ) {
            requestAnimationFrame(aux.bind(this));
          } else {
            //animationFinished();
            console.log('finished');
            setTimeout(function(){
              this.listen(this, 'scroll', '_onScroll');
            }.bind(this),300);
          }
        }.bind(this);
      }

    });
  })();
  </script>
</dom-module>
